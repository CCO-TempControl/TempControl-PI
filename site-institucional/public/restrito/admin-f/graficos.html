<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://kit.fontawesome.com/2eecc47c4e.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../../assets/js/funcoes.js"></script>
    <link rel="stylesheet" href="../style.css">
    <link rel="icon" type="image/x-icon" href="../../assets/img/Logo.png">
    <title>GRÁFICOS/ALERTAS</title>
</head>

<body onload="setUp('admin-f'), carregarEntregas()">
    <div class="wrapper">
        <div class="sidebar">
            <div class="dropdown">
                <a href="#"><i class="fa-solid fa-circle-user" style="font-size:70px;  color: white;"></i></a>
                <div class="dropdown-content">
                    <h4>Olá <span id="spanNome"></span></h4>
                </div>
            </div>
            <ul>
                <li><a href="./index.html"><i class="fas fa-home"></i>Home</a></li>
                <li><a href="./solicitacoes.html"><i class="fas fa-solid fa-file-contract"></i>Solicitações</a></li>
                <li><a href="./entregas.html"><i class="fas fa-regular fa-truck-ramp-box"></i>Entregas</a></li>
                <li><a href="./sensores.html"><i class="fas fa-solid fa-pager"></i>Sensores</a></li>
                <li><a href="./medicamentos.html"><i class="fas fa-solid fa-file-medical"></i>Medicamentos</a></li>
                <li><a href="./graficos.html"><i class="fas fa-solid fa-chart-gantt"></i></i>Gráficos/Alertas</a></li>
                <li><a href="./dadosPessoais.html"><i class="fas fa-solid fa-user"></i></i>Dados Pessoais</a></li>
                <li><a href="./usuarios.html"><i class="fas fa-solid fa-users"></i>Usuários</a></li>
                <li><a href="../../index.html" onclick="signOut()"><i
                            class="fas fa-solid fa-arrow-right-from-bracket"></i></i>Sair</a></li>
            </ul>
        </div>
        <div class="main_content">
            <div class="header">
                <!-- <input type="text" placeholder="Pesquise.."> -->
                <img src="img/logo_nome_sembg.png">
            </div>
            <div class="info">
                <div class="options">
                    <button id="btnOperacao" class="option selected" onclick="operacao()">Operação</button>
                    <button id="btnEstrategico" class="option" onclick="estrategico()">Estratégico</button>
                </div>
                <div id="idOperacao">
                    <div class="viagens">
                        <select id="selectViagem" onchange="troca();">
                        </select>
                    </div>
                    <div id="viagem1" class="viagem">
                        <div id="cards-admin-f">
                            <div class="card-admin-f">
                                <div class="card-background">
                                    <h2>Temperatura</h2>
                                </div>
                                <div class="card-information">
                                    <h3 id="temperatura-viagem">-2/12°C</h3>
                                    <small>Menor/Maior Temperatura Alcançada</small>
                                </div>
                            </div>
                            <div class="card-admin-f">
                                <div class="card-background">
                                    <h2>Umidade Relativa</h2>
                                </div>
                                <div class="card-information">
                                    <h3 id="umidade-viagem">20/80%</h3>
                                    <small>Menor/Maior Umidade Alcançada</small>
                                </div>
                            </div>
                            <div class="card-admin-f">
                                <div class="card-background">
                                    <h2>Alertas Emitidos</h2>
                                </div>
                                <div class="card-information">
                                    <h3 id="alertas-viagem">20</h3>
                                    <small>Na viagem atual 20 alertas emitidos</small>
                                </div>
                            </div>
                        </div>

                        <div id="graficos">
                            <div class="chart-container chart" style="position: relative;">
                                <h1>Temperatura Da Viagem Atual</h1>
                                <canvas id="temperatura-viagem-atual"></canvas>
                            </div>
                            <div class="chart-container chart" style="position: relative;">
                                <h1>Umidade Da Viagem Atual</h1>
                                <canvas id="umidade-viagem-atual"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="analytic" id="cards-admin-f">
                        <div class="card-admin-f">
                            <div class="card-background" id="critico">
                                <h2>Crítico</h2>
                            </div>
                            <div class="card-information">
                                <h3>2°C</h3>
                            </div>
                        </div>
                        <div class="card-admin-f">
                            <div class="card-background" id="alerta">
                                <h2>Alerta</h2>
                            </div>
                            <div class="card-information">
                                <h3>4°C</h3>
                            </div>
                        </div>
                        <div class="card-admin-f">
                            <div class="card-background" id="ideal">
                                <h2>Ideal</h2>
                            </div>
                            <div class="card-information">
                                <h3>5°C</h3>
                            </div>
                        </div>
                        <div class="card-admin-f">
                            <div class="card-background" id="alerta">
                                <h2>Alerta</h2>
                            </div>
                            <div class="card-information">
                                <h3>6°C</h3>
                            </div>
                        </div>
                        <div class="card-admin-f">
                            <div class="card-background" id="critico">
                                <h2>Crítico</h2>
                            </div>
                            <div class="card-information">
                                <h3>8°C</h3>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- Estrategico-->

                <div id="idEstrategico" style="display: none;">
                    <div id="cards-admin-f">
                        <div class="card-admin-f">
                            <div class="card-background">
                                <h2>Alertas Por Temperatura</h2>
                            </div>
                            <div class="card-information">
                                <h3>75%</h3>
                                <small>750 dos alertas ocorreram por temperatura</small>
                            </div>
                        </div>
                        <div class="card-admin-f">
                            <div class="card-background">
                                <h2>Alertas Por Umidade Relativa</h2>
                            </div>
                            <div class="card-information">
                                <h3>25%</h3>
                                <small>250 dos alertas ocorreram por umidade</small>
                            </div>


                        </div>
                        <div class="card-admin-f">
                            <div class="card-background">
                                <h2>Transportadora Mais Confiável</h2>
                            </div>
                            <div class="card-information">
                                <h3>Polar</h3>
                                <small>Emitiu Apenas 25 Alertas</small>
                            </div>
                        </div>
                        <div class="card-admin-f">
                            <div class="card-background">
                                <h2>Transportadora Mais Utilizada</h2>
                            </div>
                            <div class="card-information">
                                <h3>Polar</h3>
                                <small>Realizou 120 Viagens</small>
                            </div>
                        </div>
                    </div>

                    <div id="graficos">
                        <div class="chart-container chart" style="position: relative;">
                            <h1>Média De Alertas Mensal</h1>
                            <canvas id="media-alertas-mensal"></canvas>
                        </div>
                        <div class="chart-container chart" style="position: relative;">
                            <h1>Média De Alertas Semanal</h1>
                            <canvas id="media-alertas-semanal"></canvas>
                        </div>
                    </div>

                    <div id="graficos">
                        <div class="chart-container chart" style="position: relative;">
                            <h1>Média De Alertas Diário</h1>
                            <canvas id="media-alertas-diario"></canvas>
                        </div>
                        <div class="chart-container chart" style="position: relative;">
                            <h1>Média De Alertas Por Hora</h1>
                            <canvas id="media-alertas-hora"></canvas>
                        </div>
                    </div>
                    <div id="graficos">
                        <div class="chart-container chart" style="position: relative;width: 23vw;">
                            <h2>Observação Geral</h2>
                            <canvas id="observacao-geral"></canvas>
                        </div>

                    </div>

                </div>
            </div>
        </div>
</body>

<script>
    var graficos = {
        'operacional': [],
        'estrategico': []
    };
    var proximaAtualizacao = {
        'operacional': [],
        'estrategico': []
    };

    var entregaSolicitada = 0;
    var obtendoDados = false;
    var entregas = [];

    function renderizarGraficosOperacionais() {
        // Operacional
        // Label
        let labelHorario = [
            '09:00',
            '10:00',
            '11:00',
            '12:00',
            '13:00',
            '14:00',
            '15:00',
            '16:00',
            '17:00',
            '18:00'
        ];
        /* Gráfico 1 */

        let dadosGraficoTempAtual = [];
        var dataGraficoTempAtual = {
            labels: [],
            datasets: [{
                label: 'Alertas',
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: [],
            }]
        };

        var graficoTempAtual = new Chart(
            document.getElementById('temperatura-viagem-atual'),
            {
                type: 'line',
                data: dataGraficoTempAtual,
                options: {
                    scales: {
                        y: {
                            title: {
                                color: '#3C9DCF',
                                display: true,
                                text: 'Temperatura °C'
                            }
                        },
                        x: {
                            title: {
                                color: '#3C9DCF',
                                display: true,
                                text: 'Hora'
                            }
                        }
                    },
                    responsive: true,
                    animation: { duration: 500 },
                    hoverMode: 'index',
                    stacked: false
                }
            }
        );
        graficos.operacional.push(graficoTempAtual);


        let dadosGraficoUmiAtual = [];
        var dataGraficoUmiAtual = {
            labels: [],
            datasets: [{
                label: 'Alertas',
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: [],
            }]
        };

        var graficoUmiAtual = new Chart(
            document.getElementById('umidade-viagem-atual'),
            {
                type: 'line',
                data: dataGraficoUmiAtual,
                options: {
                    scales: {
                        y: {
                            title: {
                                color: '#3C9DCF',
                                display: true,
                                text: 'Umidade %'
                            }
                        },
                        x: {
                            title: {
                                color: '#3C9DCF',
                                display: true,
                                text: 'Hora'
                            }
                        }
                    }
                }
            }
        );
        graficos.operacional.push(graficoUmiAtual);
        
        plotarGraficosOperacionais();
    }
    
    function plotarGraficosOperacionais() {
        for (let i = 0; i < graficos.operacional.length; i++) {
            let tipoDado;
            let tipoGrafico = 'operacional';
            if (i == 0) {
                tipoDado = 'dht11temperatura'
            } else if (i == 1) {
                tipoDado = 'dht11umidade'
            }
            obterDadosGrafico(graficos.operacional[i], true, 10, tipoGrafico, tipoDado);
        }
    }
    
    function renderizarGraficosEstrategicos() {
        const labelsMeses = [
            'Abril',
            'Maio',
            'Junho',
            'Julho',
            'Agosto',
        ];

        const labelsSemana = [
            'Segunda',
            'Terça',
            'Quarta',
            'Quinta',
            'Sexta',
            'Sábado',
            'Domingo'
        ];
        const labelsDias = [
            '04/05',
            '06/05',
            '07/05',
            '08/05',
            '09/05',
            '10/05'
        ];
        const labelsHoras = [
            '09:00',
            '10:00',
            '11:00',
            '12:00',
            '13:00',
            '14:00',
            '15:00',
            '16:00',
            '17:00',
            '18:00'
        ];

        // estrategico
        let dadosAlertaMensal = [50, 10, 5, 2, 20, 30, 45, 100];
        const dataAlertaMensal = {
            labels: [],
            datasets: [{
                label: 'Alertas',
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: [],
            }]
        };
        const alertasMensal = new Chart(
            document.getElementById('media-alertas-mensal'),
            {
                type: 'line',
                data: dataAlertaMensal,
                options: {
                    scales: {
                        y: {
                            title: {
                                color: '#3C9DCF',
                                display: true,
                                text: 'Alertas'
                            }
                        }
                    }
                }
            }
        );
        graficos.estrategico.push(alertasMensal);

        let dadosAlertasSemanal = [10, 15, 5, 25, 20, 30, 45, 100];
        const dataAlertasSemanal = {
            labels: labelsSemana,
            datasets: [{
                label: 'Alertas',
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: dadosAlertasSemanal,
            }]
        };
        const alertasSemanal = new Chart(
            document.getElementById('media-alertas-semanal'),
            {
                type: 'line',
                data: dataAlertasSemanal,
                options: {
                    scales: {
                        y: {
                            title: {
                                color: '#3C9DCF',
                                display: true,
                                text: 'Alertas'
                            }
                        }
                    }
                }
            }
        );
        graficos.estrategico.push(alertasSemanal);

        let dadosAlertasDiarios = [10, 15, 5, 25, 20, 30, 45, 100];
        const dataAlertasDiarios = {
            labels: labelsDias,
            datasets: [{
                label: 'Alertas',
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: dadosAlertasDiarios,
            }]
        };
        const alertasDiario = new Chart(
            document.getElementById('media-alertas-diario'),
            {
                type: 'line',
                data: dataAlertasDiarios,
                options: {
                    scales: {
                        y: {
                            title: {
                                color: '#3C9DCF',
                                display: true,
                                text: 'Alertas'
                            }
                        }
                    }
                }
            }
        );
        graficos.estrategico.push(alertasDiario);

        let dadosAlertasHoras = [5, 15, 5, 25, 20, 30, 45, 5, 1, 50, 100];
        const dataAlertasHoras = {
            labels: labelsHoras,
            datasets: [{
                label: 'Alertas',
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: dadosAlertasHoras,
            }]
        };
        const alertasPHora = new Chart(
            document.getElementById('media-alertas-hora'),
            {
                type: 'line',
                data: dataAlertasHoras,
                options: {
                    scales: {
                        y: {
                            title: {
                                color: '#3C9DCF',
                                display: true,
                                text: 'Alertas'
                            }
                        }
                    }
                }
            }
        );
        graficos.estrategico.push(alertasPHora);


        let dadosObservacaoGeral = [10, 70, 20]
        let dataObservacaoGeral = {
            labels: [
                'Critico',
                'Média',
                'Atenção'
            ],
            datasets: [{
                data: dadosObservacaoGeral,
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)'
                ],
                hoverOffset: 4
            }]
        };
        const observacaoGeral = new Chart(
            document.getElementById('observacao-geral'),
            {
                type: 'doughnut',
                data: dataObservacaoGeral,
                options: {}
            }
        );
    }

    function obterDadosGrafico(grafico, ordenar, limite, tipoGrafico, tipoDado) {
        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }
        let viagemElement = document.getElementById('selectViagem');
        let fkEntrega = viagemElement.value;
        fetch(`/registro/obterDados/${fkEntrega}&${ordenar}&${limite}`, {
            cache: 'no-store',
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            console.log(response)
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();
                    
                    plotarGrafico(resposta, grafico, tipoGrafico, tipoDado);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function plotarGrafico(resposta, grafico, tipoGrafico, tipoDado) {
        console.log('iniciando plotagem do gráfico...');
        console.log(tipoDado)
        for (i = 0; i < resposta.length; i++) {
                var registro = resposta[i];
                grafico.data.labels.push(new Date(registro.horario).toLocaleTimeString());
                grafico.data.datasets[0].data.push(registro[tipoDado]);
                /* grafico.datasets[1].data.push(registro.dht11temperatura); */
        }
        grafico.update();
        proximaAtualizacao[tipoGrafico].push(setTimeout(() => atualizarGrafico(grafico, tipoGrafico, tipoDado), 2000));
    }

    function atualizarGrafico(grafico, tipoGrafico, tipoDado) {
        let ordenar = true;
        let limite = 1;
        fetch(`/registro/obterDados/${usuario.fkCliente}&${ordenar}&${limite}`, {
            cache: 'no-store',
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico: ${grafico}`);

                    // tirando e colocando valores no gráfico
                    grafico.data.labels.shift(); // apagar o primeiro
                    grafico.data.labels.push(new Date(novoRegistro[0].horario).toLocaleTimeString()); // incluir um novo momento
                    grafico.data.datasets[0].data.shift();  // apagar o primeiro de umidade
                    grafico.data.datasets[0].data.push(novoRegistro[0][tipoDado]); // incluir uma nova medida de umidade

                    grafico.update();

                    proximaAtualizacao[tipoGrafico].push(setTimeout(() => {atualizarGrafico(grafico, tipoGrafico, tipoDado); proximaAtualizacao[tipoGrafico].shift();}, 2000));
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                proximaAtualizacao[tipoGrafico].push(setTimeout(() => {atualizarGrafico(grafico, tipoGrafico, tipoDado); proximaAtualizacao[tipoGrafico].shift();}, 2000));
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function carregarEntregas() {
        fetch(`/entregas/obter/${usuario.fkCliente}`, {
            cache: 'no-store',
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(resposta => {
            console.log('Resposta: ', resposta);

            if (resposta.ok) {
                resposta.json().then(json => {
                    console.log(json);

                    entregas = json;

                    if (entregas.length > 0) {
                        entregaSolicitada = entregas[0].idEntrega;
                        let viagemElement = document.getElementById('selectViagem');
                        viagemElement.value = entregaSolicitada;

                        for (var index = 0; index < entregas.length; index++) {
                            var entrega = entregas[index];
                            var ocorrencia = index + 1;
                            renderizarOptEntrega(entrega, ocorrencia);
                        }
                        renderizarGraficosOperacionais();
                    }
                });
            }
        })
    }

    function renderizarOptEntrega(entrega, i) {
        selectViagem.innerHTML += `
            <option id="optEntrega#${entrega.idEntrega}" value="${entrega.idEntrega}">Entrega ${i}</option>
        `;
    }

    function obterAlertasGrafico(grafico, tipoGrafico, tipoDado) {
        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }
        let viagemElement = document.getElementById('selectViagem');
        let fkEntrega = viagemElement.value;
        fetch(`/registro/obterAlertas/${fkEntrega}&${tipoDado}`, {
            cache: 'no-store',
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            console.log(response)
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: `, JSON.stringify(resposta));
                    resposta.reverse();
                    
                    plotarGraficoEstrategico(resposta, grafico, tipoGrafico, tipoDado);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    function plotarGraficoEstrategico(resposta, grafico, tipoGrafico, tipoDado) {
        console.log('iniciando plotagem do gráfico...');
        console.log(tipoDado)
        for (i = 0; i < resposta.length; i++) {
                var registro = resposta[i];
                if (tipoDado == 'nomeDia') {
                    grafico.data.labels.push(registro.nomeDia);
                } else if (tipoDado == 'dia') {
                    grafico.data.labels.push(`${registro.dia}/${registro.mes}`);
                } else if (tipoDado == 'mes') {
                    grafico.data.labels.push(registro.mes);
                }
                grafico.data.datasets[0].data.push((registro.quantidadeAlerta / registro.quantidadeRegistro) * 100);
        }
        grafico.update();
    }
</script>

<script>
    function troca() {
        let idViagem = Number(selectViagem.value);
        let temp = document.getElementById('temperatura-viagem');
        let umid = document.getElementById('umidade-viagem');
        let alert = document.getElementById('alertas-viagem');
        let viagem = viagens.filter((viagem) => {
            return viagem.id == idViagem;
        })

        temp.innerHTML = `${-2}/${12}°C`;
        umid.innerHTML = `${20}/${80}%`;
        alert.innerHTML = viagem[0].alertas;

        for (let i = 0; i < graficos.operacional.length; i++) {
            grafico.operacional[i].labels = [];
            grafico.operacional[i].data.datasets[0].data = [];
        }
        for (let i = 0; i < proximaAtualizacao.operacional.length; i++) {
            clearTimeout(proximaAtualizacao.operacional[i]);
        }
        proximaAtualizacao.operacional = [];
        plotarGraficosOperacionais();
    }

    function operacao() {
        btnOperacao.classList.add('selected');
        btnEstrategico.classList.remove('selected');
        idEstrategico.style.display = 'none';
        idOperacao.style.display = 'block';
    }

    async function estrategico() {
        btnEstrategico.classList.add('selected');
        btnOperacao.classList.remove('selected');
        idOperacao.style.display = 'none';
        idEstrategico.style.display = 'block';
        for (let i = 0; i < proximaAtualizacao.operacional.length; i++) {
            clearTimeout(proximaAtualizacao.operacional[i]);
        }
        proximaAtualizacao.operacional = [];
        renderizarGraficosEstrategicos();
        
        let tipoGrafico = 'estrategico';
        let tipoDado = 'mes';
        /* for (let i = 0; i < graficos.estrategico.length; i++) {
            if (i == 0) {
                tipoDado = 'mes';
            } else if (i == 1) {
                tipoDado = 'nomeDia';
            } else if (i == 2) {
                tipoDado = 'dia';
            } else if (i== 3) {
                tipoDado = 'tempo';
            }
            
        } */
        await obterAlertasGrafico(graficos.estrategico[0], tipoGrafico, tipoDado)
    }

    function carregarKPI(fkEntrega) {
        fetch(`/registro/obterKPI/${fkEntrega}`, {
            cache: 'no-store',
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (response) {
            console.log(response)
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                });
            }
            });
    }

</script>



</html>