<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://kit.fontawesome.com/2eecc47c4e.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="../style.css">
  <link rel="icon" type="image/x-icon" href="../../assets/img/Logo.png">
  <script src="../../assets/js/funcoes.js"></script>
  <script src="../../assets/js/validacoes.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <title>USUÁRIOS</title>
</head>
<body onload="carregarEntregas();obterDadosGrafico(1000,true,10);">
    <div>
        <div style="display: flex;">
            <select id="cmbEntrega"></select>
        </div>
        <div style="display: flex; justify-content: space-around;" id="metrica">
            <div id="divTemperatura"></div>
            <div id="divAlerta"></div>
            <div id="divUmidade"></div>
        </div>
        <div style="display: flex; justify-content: center; align-items: center; width: 60vw; " id="graficos">
            <canvas id="chartTemp"></canvas>
         
        </div>
        <div style="display: flex; justify-content: space-around;">
            <div id="divCriticoBaixo"></div>
            <div id="divAvisoBaixo"></div>
            <div id="divIdeal"></div>
            <div id="divAvisoAlto"></div>
            <div id="divCriticoAlto"></div>
        </div>
    </div>
</body>
</html>






























<script>
      var dadosSession = obterDadosSession();
  var nome = dadosSession.nomeUsuario;
  var email = dadosSession.emailUsuario;
  var fkCliente = dadosSession.fkCliente;
  var idAdmin = dadosSession.idUsuario;
    var entregas = []

    function carregarEntregas() {
        fetch(`/entregas/obter/${fkCliente}`, {
            cache: 'no-store',
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(resposta => {
            console.log('Resposta: ', resposta);

            if (resposta.ok) {
                resposta.json().then(json => {
                    console.log(json);

                    entregas = json;

                    if (entregas.length > 0) {
                        for (var index = 0; index < entregas.length; index++) {
                            var entrega = entregas[index];
                            var ocorrencia = index + 1;
                            renderizarOptEntrega(entrega, ocorrencia);
                        }
                    }
                });
            }
        })
    }

    function renderizarOptEntrega(entrega, i) {
        cmbEntrega.innerHTML += `
            <option id="optEntrega#${entrega.idEntrega}" value="${entrega.idEntrega}">Entrega ${i}</option>
        `;
    }


    function obterDadosGrafico(idAquario,ordenar,limite) {
        fetch(`/registro/obterDados/${idAquario}&${ordenar}&${limite}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idAquario);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta, idAquario) {
        console.log('iniciando plotagem do gráfico...');

        var dados = {
            labels: [],
            datasets: [
                {
                    yAxisID: 'y-temperatura',
                    label: 'Temperatura',
                    borderColor: '#FFF',
                    backgroundColor: '#32b9cd8f',
                    fill: true,
                    data: []
                }
            ]
        };

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            dados.labels.push(registro.horario);
            dados.datasets[0].data.push(registro.dht11temperatura);
        }

        console.log(JSON.stringify(dados));

        var ctx = chartTemp.getContext('2d');
        window.grafico_linha = new Chart(ctx, {
            data: dados,
            type: 'line',
            options: {
                responsive: true,
                animation: { duration: 500 },
                hoverMode: 'index',
                stacked: false,
                title: {
                    display: false,
                    text: 'Dados capturados'
                },

            }
        });
        setTimeout(() => atualizarGrafico(idAquario, dados), 2000);
    }

    function atualizarGrafico(idAquario, dados) {

fetch(`/registro/tempo-real/${idAquario}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
        response.json().then(function (novoRegistro) {

            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico: ${dados}`);

            // tirando e colocando valores no gráfico
            dados.labels.shift(); // apagar o primeiro
            dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento
            
            dados.datasets[0].data.shift();  // apagar o primeiro de umidade
            dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade
            
            dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
            dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

            window.grafico_linha.update();

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados), 2000);
        });
    } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados), 2000);
    }
})
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });

}
    
/* 
const selectElement = document.getElementById('cmbEntrega');
selectElement.addEventListener('click', (event) => {
const optionValue = cmbEntrega.value;
alert("sexo");
renderiza(optionValue);
alert("sexo");
}); *//* 

    function renderiza(optionValue) {
        metrica.innerHTML += `
        <div id="cards-admin-f">
                            <div class="card-admin-f">
                                <div class="card-background">
                                    <h2>Temperatura</h2>
                                </div>
                                <div class="card-information">
                                    <h3 id="temperatura-viagem">${}</h3>
                                    <small>Menor/Maior Temperatura Alcançada</small>
                                </div>
                            </div>
                            <div class="card-admin-f">
                                <div class="card-background">
                                    <h2>Umidade Relativa</h2>
                                </div>
                                <div class="card-information">
                                    <h3 id="umidade-viagem">20/80%</h3>
                                    <small>Menor/Maior Umidade Alcançada</small>
                                </div>
                            </div>
                            <div class="card-admin-f">
                                <div class="card-background">
                                    <h2>Alertas Emitidos</h2>
                                </div>
                                <div class="card-information">
                                    <h3 id="alertas-viagem">20</h3>
                                    <small>Na viagem atual 20 alertas emitidos</small>
                                </div>
                            </div>
                        </div>
        `; */

</script>