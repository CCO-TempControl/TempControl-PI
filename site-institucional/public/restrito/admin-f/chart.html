<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://kit.fontawesome.com/2eecc47c4e.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="../style.css">
  <link rel="icon" type="image/x-icon" href="../../assets/img/Logo.png">
  <script src="../../assets/js/funcoes.js"></script>
  <script src="../../assets/js/validacoes.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.min.js" integrity="sha512-F+u8eWHrfY8Xw9BLzZ8rG/0wIvs0y+JyRJrXjp3VjtFPylAEEGwKbua5Ip/oiVhaTDaDs4eU2Xtsxjs/9ag2bQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <title>USUÁRIOS</title>
</head>
<body onload="carregarEntregas();">
    <div>
        <div style="display: flex;">
            <select id="cmbEntrega"></select>
        </div>
        <div style="display: flex; justify-content: space-around;" id="metrica">
            <div id="divTemperatura"></div>
            <div id="divAlerta"></div>
            <div id="divUmidade"></div>
        </div>
        <div style="display: flex; justify-content: center; align-items: center; width: 60vw; " id="graficos">
            <canvas id="chartTemp"></canvas>
         
        </div>
        <div style="display: flex; justify-content: space-around;">
            <div id="divCriticoBaixo"></div>
            <div id="divAvisoBaixo"></div>
            <div id="divIdeal"></div>
            <div id="divAvisoAlto"></div>
            <div id="divCriticoAlto"></div>
        </div>
    </div>
</body>
</html>
<script>
    var dadosSession = obterDadosSession();
    var nome = dadosSession.nomeUsuario;
    var email = dadosSession.emailUsuario;
    var fkCliente = dadosSession.fkCliente;
    var idAdmin = dadosSession.idUsuario;

    var entregaSolicitada = 0;
    var obtendoDados = false;
    var entregas = [];
    
    var ctx = chartTemp.getContext('2d');
    var grafico = new Chart(ctx, {
        data: {
            labels: [],
            datasets: [
                {
                    axis: 'y',
                    yAxisID: 'y-temperatura',
                    label: 'Temperatura',
                    borderColor: '#32b9cd8f',
                    backgroundColor: '#32b9cd8f',
                    data: []
                }
            ]
        },
        type: 'line',
        options: {
            responsive: true,
            animation: { duration: 500 },
            hoverMode: 'index',
            stacked: false,
            title: {
                display: false,
                text: 'Dados capturados'
            }
        }
    });

    setInterval(() => {
        if (!obtendoDados && entregaSolicitada > 0) {
            obterDadosOperacao();
        }
    }, 1000);

    function carregarEntregas() {
        fetch(`/entregas/obter/${fkCliente}`, {
            cache: 'no-store',
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(resposta => {
            console.log('Resposta: ', resposta);

            if (resposta.ok) {
                resposta.json().then(json => {
                    console.log(json);

                    entregas = json;

                    if (entregas.length > 0) {
                        entregaSolicitada = entregas[0].idEntrega;
                        cmbEntrega.value = entregaSolicitada;

                        for (var index = 0; index < entregas.length; index++) {
                            var entrega = entregas[index];
                            var ocorrencia = index + 1;
                            renderizarOptEntrega(entrega, ocorrencia);
                        }
                    }
                });
            }
        })
    }

    function renderizarOptEntrega(entrega, i) {
        cmbEntrega.innerHTML += `
            <option id="optEntrega#${entrega.idEntrega}" value="${entrega.idEntrega}">Entrega ${i}</option>
        `;
    }

    function obterDadosOperacao() {
        obtendoDados = true;
        obterDadosGraficoOperacao();
        obterDadosKPIOperacao();
        setTimeout(() => {
            obtendoDados = false;
        }, 250);
    }

    function obterDadosGraficoOperacao() {
        fetch(`/registro/obterDados/${entregaSolicitada}&${true}&${10}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, entregaSolicitada);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        }).catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta, idEntrega) {
        console.log('iniciando plotagem do gráfico...');

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];

            var dataFormatada = dateFns.format(registro.horario, 'hh:mm DD/MM/YY');
            var temperatura = parseFloat(registro.dht11temperatura)

            grafico.data.labels.push(dataFormatada);
            grafico.data.datasets[0].data.push(temperatura);
        }
    }

    function obterDadosKPIOperacao() {
        fetch(`/entregas/operacao/kpi/${entregaSolicitada}`, {
            cache: 'no-store',
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(resposta => {
            console.log('Resposta: ', resposta);

            if (resposta.ok) {
                resposta.json().then(json => {
                    console.log("Olha aqui",json);
                });
            }
        }).catch(erro => {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        })
    }
</script>